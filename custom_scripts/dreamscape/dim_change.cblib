# Defines what happens when the player enters each of the dream dimensions.

import player_id

reset
    # Revoke any advancement here, just in case
    /advancement revoke @a only $namespace:dimension_change_sky
    # Revoke the advancement so it can be granted again next time
    /advancement revoke @s only $namespace:dream_join

    # Set up leaving scoreboard
    ## Detects when player has left the game to determine if they left while in a dream
    /scoreboard objectives add dream_leave minecraft.custom:minecraft.leave_game
    @s.dream_leave = 1
end

# Detects when player has joined the game to determine if they joined while in a dream
advancement dream_join {
	criteria: {
		requirement: {
			trigger: "minecraft:tick"
        }
	},
	rewards: {
		"function": "$namespace:_start_handle_join"
	}
}

# This advancement triggers the '_on_dim_change_sky' function
advancement dimension_change_sky {
    criteria: {
        dim_change: {
            trigger: "minecraft:changed_dimension",
            conditions: {
                "from": "minecraft:overworld",
                "to": "$namespace:sky"
            }
        }
    },
    rewards: {
        "function": "$namespace:_on_dim_change_sky"
    }
}

# Used to detect when a player leaves the game
clock handle_leave
    # If the player ever has a dream_leave value, set it back to 0 and run the _handle_leave function
    as @a
        if @s.dream_leave
            # Revoke the advancement so it can be granted again next time
            /advancement revoke @s only $namespace:dream_join
            # Set the player's leave value back to 0
            @s.dream_leave = 0
        end
    end
end

# If a player joins while in a dream, set up that dream's stuff
function _start_handle_join()
    # Executes with the ID macro
    with
        $(ID) = @s.ID
    do
        # Grab the player's current dimension
        /$data modify storage $namespace:global dimensions[{ID:$(ID)}].dim set from entity @s Dimension
        # Execute the generic handle_join function with the dimension value
        /$execute run function $namespace:_handle_join with storage $namespace:global dimensions[{ID:$(ID)}]
    end
end

# Generically handles the joining of the world
function _handle_join()
    /$execute if dimension $(dim) run function $namespace:_on_dim_change_sky
end

# Fires anytime player enters the sky dimension
function _on_dim_change_sky()
    # Stops any currently playing music
    /stopsound @s music minecraft:music.game
    # Might wanna add a delay to this starting to simulate what it looks like in the actual dimension_type structure
    /playsound $namespace:music.game music @s ~ ~ ~ 1

    # Always remoke the advancement last, that way play can run this function again
    /advancement revoke @s only $namespace:dimension_change_sky
end